# Concourse Docker Local Configuration

First, See the README.md for general information.  This note covers the local configuration
and adaptation.

## Concourse & Vault, Simple Integration

This configuration is meant to be the simplest integration of Concourse with Vault.
It is suitable for running the Concourse tutorials (without using bucc).

Not for production use.

## Vault (dev instance)

It is assumed that a [Vault](https://www.vaultproject.io/) server is available.
It does not need to be anything more than a "dev" server.  Generally, it is
run in a [container](https://github.com/hashicorp/docker-vault).

Token authentication is used.

The policy for Concourse access to Vault is defined in `concourse-policy.hcl`  This must be
written to the Vault instance.

See [Vault Credential Manager](https://concourse-ci.org/vault-credential-manager.html).

## Concourse

The vanilla Concourse servers are run: the base is [concourse/concourse-docker](https://github.com/concourse/concourse-docker).

## Local Configuration

Local configuration is accomplished by using a `docker-compose.override.yml` file.
As well, sensitive information is kept in `private/credentials` that needs to
be sourced (`--env-file`) when Concourse is brought up with docker-compose.
Be sure that `private/credentials` is not included in the git repo using `.gitignore`
or (worst case) being careful.

1. The "test/test" default user is replaced. This is defined in the credentials file.
2. The `MAIN_TEAM_LOCAL_USER` is changed to "clem".
3. The Vault URL is defined depending where Vault is running and how it is configured.
4. A shared search path for Vault secrets is defined ("shared").
5. The `VAULT_CLIENT_TOKEN` is placed in the credentials file.  This must be generated by the Vault instance.

## Differences from Generic Repo

1. Additional files are present:
    1. `docker-compose.override.yml`
    2. `concourse-policy.hcl`
    3. `README-LOCAL.md`
    4. In the `prototype` directory: `up`, `down`, and `credentials`.

None of the official repo files are altered, so it is possible to easily pull
changes from upstream.

## Setup Steps

1. Clone the this repo.  You might want to make branches to represent different local configurations.

It is assumed that you have Docker set up and running.

2. Generate the Concourse keys as described in `README.md`
3. Copy `prototype/credentials` into `private/credentials` and restrict read/write permissions. Be sure that git ignores the `private` directory and its contents.
4. Copy `prototype/up` and `prototype/down` to `bin`.  Edit if you wish (generally not necessary).  Note that the `bin` directory is ignored by git so that local commands can be added/maintained without messing up the standard repo.
5. Edit `private/credentials` to change the default user (or just leave it as "clem/worker" if you wish). At this point, Concourse can be run (without Vault).

It is assumed from now on that you have Vault set up and running.

6. Generate a [Vault token](https://concourse-ci.org/vault-credential-manager.html#vault-periodic-token). Edit the credentials file, adding the token string.
7. Set the Vault URL in `docker-compose.override.yml`  This is the same URL that is used to browse using the Vault web UI. It is assumed that Vault and Concourse are not using tls/ssl. So, the URL is "http" and not "https".
8. Use directly, or edit `concourse-policy.hcl`.  This defines the Concourse access rights to Vault and implicitly where secrets are going to be stored.  The default is as described in [Configuring the Secrets Engine](https://concourse-ci.org/vault-credential-manager.html#configuring-the-secrets-engine).

## Running

The two simple scripts--`up` and `down`--make clear how
the credentials file is included.  Concourse is brought up in the background ("-d").

Bring Concourse up with `bin/up` and down with `bin/down`.

You might want to try out the [parameters](https://concoursetutorial.com/basics/parameters/) tutorial using a credentials manager as described in [Secret Parameters](https://concoursetutorial.com/basics/secret-parameters/) but this time using Vault instead of "bucc".
