# Concourse Docker Local Configuration

First, see the README.md for general information.  This note covers the local configuration
and adaptation.

## Concourse & Vault, Simple Integration

This configuration is meant to be a simple integration of Concourse with Vault.
It is suitable for running the Concourse tutorials (without using bucc).

Not for production use.

## Vault (dev)

It is assumed that a [Vault](https://www.vaultproject.io/) server is available.
It does not need to be anything more than a "dev" server.  Generally, it is
run in a [container](https://github.com/hashicorp/docker-vault).

Token authentication is used.

The policy for Concourse access to Vault is defined in `concourse-policy.hcl`  This must be
written to the Vault instance.

See [Vault Credential Manager](https://concourse-ci.org/vault-credential-manager.html).

## Vault (server)

A slightly more complex configuration, on both the Vault and Concourse sides, is using
a Vault "server" instance (data is persisted, unsealing is necessary, and TLS protects
the communication.  Optionally, TLS can be used to authenticate clients instead of a
Vault generated token.

## Concourse

The vanilla Concourse servers are run: the base (and upstream for this repo) is [concourse/concourse-docker](https://github.com/concourse/concourse-docker).

## Local Configuration

Local configuration is accomplished by using a `docker-compose.override.yml` file.
As well, sensitive information is kept in `private/env/credentials`; other settings are kept
in `private/env/settings`. These credentials and settings need to
be sourced (`--env-file`) when Concourse is brought up with `docker-compose`.
Unfortunately, only a single such "env" file can be sourced by docker-compose. The
`up` script shows how the various files are first concatenated together prior to
sourcing.

Be sure that `private/env/credentials` is not included in the git repo using `.gitignore`
or (worst case) being careful.  Easiest is simply to ignore everything below `private`.

1. The "test/test" default user is replaced. This is defined in the credentials file.
2. The `MAIN_TEAM_LOCAL_USER` is changed to "clem".
3. The Vault URL is defined depending where Vault is running and how it is configured.
The hostname and other parts of the URL are defined in `private/env/settings`.
This settings file can also be used, for example,
to generate Vault server certificates such that the URL used by Concourse matches the
Vault cert. N.B. that the URL determines the use of HTTPS vs. HTTP.  This must be
consistent with Vault: TLS enabled or not.
4. A shared search path for Vault secrets is defined ("shared").
5. The `VAULT_CLIENT_TOKEN` is placed in the credentials file.  This must be generated by the Vault instance. This is necessary when Token authentication is being used.
6. The Vault Certificate Authority (CA) certificate is placed in `private/tls`. This is the CA that issued the Vault server certificate and is used by Concourse to authenticate Vault. `private/tls` is mounted in the web container as `/tls`.
7. When TLS authentication is being used, the Concourse TLS certificate and key files are also placed in `private/tls`. This certificate may be issued by any CA including the CA that issued the Vault certificate.

## Differences from Generic Repo

1. Additional files are present:
    1. `docker-compose.override.yml`
    2. `concourse-policy.hcl`
    3. `README-LOCAL.md`
    4. In the `prototype` directory: `up`, `down`, `init`, `settings`, and `credentials`.

None of the official repo files are altered, so it is possible to easily pull
changes from upstream.

## Setup Steps

1. Clone this repo.  You might want to make branches to represent different local configurations.

It is assumed that you have Docker set up and running.

2. Generate the Concourse keys as described in `README.md`

3. From the top-level directory of the repo, run `prototype/init`. Be sure that git ignores the `private` directory and its contents.

4. Edit the scripts in `bin` if you wish (generally not necessary).  Note that the `bin` directory is ignored by git so that local commands can be added/maintained without messing up the standard repo.

5. Edit `private/env/credentials` to change the default user (or just leave it as "clem/worker" if you wish). At this point, Concourse can be run (without Vault) as long as any other dependencies in `docker-compose.override.yml` are satisfied (e.g. certs to be loaded even if not used).

It is assumed from now on that you have Vault set up and running.

6. Following the section [Configuring the Secrets Engine](https://concourse-ci.org/vault-credential-manager.html#configuring-the-secrets-engine):
    1. Enable a "secrets engine" (e.g. `kv`).
    2. Create an appropriate policy: use directly, or edit, `concourse-policy.hcl` This defines
the Concourse access rights to Vault and implicitly where secrets are going to be stored.
This might be a good point to create some secrets in the location specified in the policy.
    3. If you are using Token authentication, generate a [Vault token](https://concourse-ci.org/vault-credential-manager.html#vault-periodic-token). Edit the credentials file, adding the token string. If using TLS authentication, this is not necessary.

7. Set the Vault hostname and URL in `private/env/settings`  This is the same URL that is used to browse using the Vault web UI. Depending if TLS is being used or not, the URL is "http" or "https".

8. If TLS is being used to communicate between Vault and Concourse, copy the Vault CA certificate to `private/tls/vault-ca.crt`

9. If TLS authentication is being used, then you will need a (client) certificate for Concourse and its key.
These need to be placed in `private/tls/concourse.crt` and `private/tls/concourse.key`.
See [Using the cert auth backend](https://concourse-ci.org/vault-credential-manager.html#vault-cert-auth).
The "cert" authentication method needs to be set in `docker-compose.override.yml` and the appropriate
environment variables set to the certificate and key files. Note that there is a bit of configuration to
be done on the Vault side to get TLS authentication running. Besides the documentation on the "cert auth backend", see
the [companion Vault project](https://github.com/ranger6/vault-docker).

## Running

The two simple scripts--`up` and `down`--make clear how the
credentials and settings files are included.  Concourse is brought up in the background ("-d").

Bring Concourse up with `bin/up` and down with `bin/down`.

You might want to try out the [parameters](https://concoursetutorial.com/basics/parameters/) tutorial using a credentials manager as described in [Secret Parameters](https://concoursetutorial.com/basics/secret-parameters/) but this time using Vault instead of "bucc".
